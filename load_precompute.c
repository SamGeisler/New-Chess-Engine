#include "global.h"
#include "load_precompute.h"

uint64_t inBetween[64][64];
uint64_t* rookDestInt[64];
uint64_t* bishopDestInt[64];

void loadDestBB();//Load destination bitboards
void loadIB();//Load inbetween lookup

int load_precompute(){
    printf("Loading precomputed data...\n");
    loadDestBB();
    loadIB();
    return 1;
}

void loadDestBB(){
    FILE* dest_fptr = fopen("rookDestReal.txt","r");//Destination bb based on intersections with other pieces
    FILE* int_fptr = fopen("rookIntersections.txt","r");//Possible intersections

    for(int src = 0; src<64; src++){
        int hash_capacity = SHIFT(rookMN_w[src]);
        int num_entries = SHIFT(count_bits(rookDestTrunc[src]));

        rookDestInt[src] = (uint64_t*)malloc(hash_capacity * sizeof(uint64_t));

        for(int i = 0; i<num_entries; i++){
            uint64_t dest_bb;
            uint64_t int_bb;
            fscanf(dest_fptr,"%llX",&dest_bb);
            fscanf(int_fptr,"%llX",&int_bb);

            int index = (rookMN[src] * int_bb)>>(64-rookMN_w[src]);
            rookDestInt[src][index] = dest_bb;
        }
    }

    fclose(dest_fptr);
    fclose(int_fptr);
    dest_fptr = fopen("bishopDestReal.txt","r");
    int_fptr = fopen("bishopIntersections.txt","r");

    for(int src = 0; src<64; src++){
        int hash_capacity = SHIFT(bishopMN_w[src]);
        int num_entries = SHIFT(count_bits(bishopDestTrunc[src]));

        bishopDestInt[src] = (uint64_t*)malloc(hash_capacity * sizeof(uint64_t));

        for(int i = 0; i<num_entries; i++){
            uint64_t dest_bb;
            uint64_t int_bb;
            fscanf(dest_fptr,"%llX",&dest_bb);
            fscanf(int_fptr,"%llX",&int_bb);

            int index = (bishopMN[src] * int_bb)>>(64-bishopMN_w[src]);
            bishopDestInt[src][index] = dest_bb;
        }
    }

    fclose(dest_fptr);
    fclose(int_fptr);
}

void loadIB(){
    FILE* fptr = fopen("ib.txt","r");
    for(int i = 0; i<64; i++){
        for(int j = 0; j<64; j++){
            fscanf(fptr, "%llX",&(inBetween[i][j]));
        }
    }
    
    fclose(fptr);
}


//Bitboard of avaiable destinations given starting square
uint64_t knightDest[64] = {0x20400, 0x50800, 0xA1100, 0x142200, 0x284400, 0x508800, 0xA01000, 0x402000, 0x2040004, 0x5080008, 0xA110011, 0x14220022, 0x28440044, 0x50880088, 0xA0100010, 0x40200020, 0x204000402, 0x508000805, 0xA1100110A, 0x1422002214, 0x2844004428, 0x5088008850, 0xA0100010A0, 0x4020002040, 0x20400040200, 0x50800080500, 0xA1100110A00, 0x142200221400, 0x284400442800, 0x508800885000, 0xA0100010A000, 0x402000204000, 0x2040004020000, 0x5080008050000, 0xA1100110A0000, 0x14220022140000, 0x28440044280000, 0x50880088500000, 0xA0100010A00000, 0x40200020400000, 0x204000402000000, 0x508000805000000, 0xA1100110A000000, 0x1422002214000000, 0x2844004428000000, 0x5088008850000000, 0xA0100010A0000000, 0x4020002040000000, 0x400040200000000, 0x800080500000000, 0x1100110A00000000, 0x2200221400000000, 0x4400442800000000, 0x8800885000000000, 0x100010A000000000, 0x2000204000000000, 0x4020000000000, 0x8050000000000, 0x110A0000000000, 0x22140000000000, 0x44280000000000, 0x88500000000000, 0x10A00000000000, 0x20400000000000};
uint64_t kingDest[64] = {0x302, 0x705, 0xE0A, 0x1C14, 0x3828, 0x7050, 0xE0A0, 0xC040, 0x30203, 0x70507, 0xE0A0E, 0x1C141C, 0x382838, 0x705070, 0xE0A0E0, 0xC040C0, 0x3020300, 0x7050700, 0xE0A0E00, 0x1C141C00, 0x38283800, 0x70507000, 0xE0A0E000, 0xC040C000, 0x302030000, 0x705070000, 0xE0A0E0000, 0x1C141C0000, 0x3828380000, 0x7050700000, 0xE0A0E00000, 0xC040C00000, 0x30203000000, 0x70507000000, 0xE0A0E000000, 0x1C141C000000, 0x382838000000, 0x705070000000, 0xE0A0E0000000, 0xC040C0000000, 0x3020300000000, 0x7050700000000, 0xE0A0E00000000, 0x1C141C00000000, 0x38283800000000, 0x70507000000000, 0xE0A0E000000000, 0xC040C000000000, 0x302030000000000, 0x705070000000000, 0xE0A0E0000000000, 0x1C141C0000000000, 0x3828380000000000, 0x7050700000000000, 0xE0A0E00000000000, 0xC040C00000000000, 0x203000000000000, 0x507000000000000, 0xA0E000000000000, 0x141C000000000000, 0x2838000000000000, 0x5070000000000000, 0xA0E0000000000000, 0x40C0000000000000};
uint64_t rookDest[64] = {0x1010101010101FE, 0x2020202020202FD, 0x4040404040404FB, 0x8080808080808F7, 0x10101010101010EF, 0x20202020202020DF, 0x40404040404040BF, 0x808080808080807F, 0x10101010101FE01, 0x20202020202FD02, 0x40404040404FB04, 0x80808080808F708, 0x101010101010EF10, 0x202020202020DF20, 0x404040404040BF40, 0x8080808080807F80, 0x101010101FE0101, 0x202020202FD0202, 0x404040404FB0404, 0x808080808F70808, 0x1010101010EF1010, 0x2020202020DF2020, 0x4040404040BF4040, 0x80808080807F8080, 0x1010101FE010101, 0x2020202FD020202, 0x4040404FB040404, 0x8080808F7080808, 0x10101010EF101010, 0x20202020DF202020, 0x40404040BF404040, 0x808080807F808080, 0x10101FE01010101, 0x20202FD02020202, 0x40404FB04040404, 0x80808F708080808, 0x101010EF10101010, 0x202020DF20202020, 0x404040BF40404040, 0x8080807F80808080, 0x101FE0101010101, 0x202FD0202020202, 0x404FB0404040404, 0x808F70808080808, 0x1010EF1010101010, 0x2020DF2020202020, 0x4040BF4040404040, 0x80807F8080808080, 0x1FE010101010101, 0x2FD020202020202, 0x4FB040404040404, 0x8F7080808080808, 0x10EF101010101010, 0x20DF202020202020, 0x40BF404040404040, 0x807F808080808080, 0xFE01010101010101, 0xFD02020202020202, 0xFB04040404040404, 0xF708080808080808, 0xEF10101010101010, 0xDF20202020202020, 0xBF40404040404040, 0x7F80808080808080};
uint64_t bishopDest[64] = {0x8040201008040200, 0x80402010080500, 0x804020110A00, 0x8041221400, 0x182442800, 0x10204885000, 0x102040810A000, 0x102040810204000, 0x4020100804020002, 0x8040201008050005, 0x804020110A000A, 0x804122140014, 0x18244280028, 0x1020488500050, 0x102040810A000A0, 0x204081020400040, 0x2010080402000204, 0x4020100805000508, 0x804020110A000A11, 0x80412214001422, 0x1824428002844, 0x102048850005088, 0x2040810A000A010, 0x408102040004020, 0x1008040200020408, 0x2010080500050810, 0x4020110A000A1120, 0x8041221400142241, 0x182442800284482, 0x204885000508804, 0x40810A000A01008, 0x810204000402010, 0x804020002040810, 0x1008050005081020, 0x20110A000A112040, 0x4122140014224180, 0x8244280028448201, 0x488500050880402, 0x810A000A0100804, 0x1020400040201008, 0x402000204081020, 0x805000508102040, 0x110A000A11204080, 0x2214001422418000, 0x4428002844820100, 0x8850005088040201, 0x10A000A010080402, 0x2040004020100804, 0x200020408102040, 0x500050810204080, 0xA000A1120408000, 0x1400142241800000, 0x2800284482010000, 0x5000508804020100, 0xA000A01008040201, 0x4000402010080402, 0x2040810204080, 0x5081020408000, 0xA112040800000, 0x14224180000000, 0x28448201000000, 0x50880402010000, 0xA0100804020100, 0x40201008040201};

//Same as above, assuming empty board and excluding final square
uint64_t rookDestTrunc[64] = {0x101010101017E, 0x202020202027C, 0x404040404047A, 0x8080808080876, 0x1010101010106E, 0x2020202020205E, 0x4040404040403E, 0x8080808080807E, 0x1010101017E00, 0x2020202027C00, 0x4040404047A00, 0x8080808087600, 0x10101010106E00, 0x20202020205E00, 0x40404040403E00, 0x80808080807E00, 0x10101017E0100, 0x20202027C0200, 0x40404047A0400, 0x8080808760800, 0x101010106E1000, 0x202020205E2000, 0x404040403E4000, 0x808080807E8000, 0x101017E010100, 0x202027C020200, 0x404047A040400, 0x8080876080800, 0x1010106E101000, 0x2020205E202000, 0x4040403E404000, 0x8080807E808000, 0x1017E01010100, 0x2027C02020200, 0x4047A04040400, 0x8087608080800, 0x10106E10101000, 0x20205E20202000, 0x40403E40404000, 0x80807E80808000, 0x17E0101010100, 0x27C0202020200, 0x47A0404040400, 0x8760808080800, 0x106E1010101000, 0x205E2020202000, 0x403E4040404000, 0x807E8080808000, 0x7E010101010100, 0x7C020202020200, 0x7A040404040400, 0x76080808080800, 0x6E101010101000, 0x5E202020202000, 0x3E404040404000, 0x7E808080808000, 0x7E01010101010100, 0x7C02020202020200, 0x7A04040404040400, 0x7608080808080800, 0x6E10101010101000, 0x5E20202020202000, 0x3E40404040404000, 0x7E80808080808000};
uint64_t bishopDestTrunc[64] = {0x40201008040200, 0x402010080400, 0x4020100A00, 0x40221400, 0x2442800, 0x204085000, 0x20408102000, 0x2040810204000, 0x20100804020000, 0x40201008040000, 0x4020100A0000, 0x4022140000, 0x244280000, 0x20408500000, 0x2040810200000, 0x4081020400000, 0x10080402000200, 0x20100804000400, 0x4020100A000A00, 0x402214001400, 0x24428002800, 0x2040850005000, 0x4081020002000, 0x8102040004000, 0x8040200020400, 0x10080400040800, 0x20100A000A1000, 0x40221400142200, 0x2442800284400, 0x4085000500800, 0x8102000201000, 0x10204000402000, 0x4020002040800, 0x8040004081000, 0x100A000A102000, 0x22140014224000, 0x44280028440200, 0x8500050080400, 0x10200020100800, 0x20400040201000, 0x2000204081000, 0x4000408102000, 0xA000A10204000, 0x14001422400000, 0x28002844020000, 0x50005008040200, 0x20002010080400, 0x40004020100800, 0x20408102000, 0x40810204000, 0xA1020400000, 0x142240000000, 0x284402000000, 0x500804020000, 0x201008040200, 0x402010080400, 0x2040810204000, 0x4081020400000, 0xA102040000000, 0x14224000000000, 0x28440200000000, 0x50080402000000, 0x20100804020000, 0x40201008040200};

//Magic numbers
int rookMN_w[64] = {13, 12, 13, 13, 13, 13, 12, 13, 12, 11, 11, 11, 11, 11, 11, 12, 12, 11, 11, 11, 11, 11, 10, 11, 12, 11, 11, 11, 11, 11, 11, 11, 12, 11, 11, 11, 11, 11, 10, 12, 12, 11, 11, 11, 11, 11, 10, 11, 12, 11, 11, 11, 11, 11, 11, 11, 13, 11, 11, 11, 12, 12, 11, 12};
int bishopMN_w[64]={6, 5, 5, 5, 5, 5, 5, 6, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 7, 8, 8, 8, 5, 5, 5, 5, 8, 10, 11, 8, 5, 5, 5, 5, 7, 11, 11, 7, 5, 5, 5, 5, 8, 8, 8, 7, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 6, 5, 5, 5, 5, 5, 5, 6};
uint64_t rookMN[64] = {0xC9873C62385CB89F, 0x10C31FAD8CEAA30D, 0xCF5E04D70671F0A3, 0x89B92A9D723B3B55, 0xC6E64BC5D919CBB3, 0xA514179558BC361D, 0x39C013037F09CD08, 0xDC11AB87F9E635EE, 0x33FCAF149167CBB1, 0xF0215351FA4EC13B, 0x3C44E943A79118D2, 0xCF128B254EED659, 0x63F09D52A0509D44, 0xABFC00C31FE1314, 0x38E0900BA684979F, 0x3EDE5454B04943B4, 0x9659334D6162F60, 0x5AF94E9FFD7A217E, 0x7F7D05ED060861C, 0xFB4B3E0020060310, 0x3C6FAF0F0EC909B7, 0x347362A006C981FD, 0x9FB084004B1E2850, 0x4FB2CA001C0DC58D, 0x5CDCAFEA46A19FDE, 0x3B70668273DBE7B6, 0x3082A6E8778A81DD, 0x4E7625655222EBBF, 0x5D49263BDF92B3B, 0x4B34083FEF84EE24, 0xF0606F5D83103C07, 0x80BA1062000B1F6C, 0xFEA44F41CA00125F, 0xD3D59728BFC03E5A, 0xDF4DEAA4B06AACAD, 0x78BF37ACC851F48D, 0x13DCE28A85A5A5BE, 0x56BB0A640011EA52, 0xB95428160C00D005, 0x69E48ECA21937837, 0xB03CF520F600A3D7, 0x6F8A5D37EC9F3322, 0x896B24E807605401, 0xFA475610D9F0DA1C, 0xAA650F8B20FF8B2D, 0x26A2EFC4E588008D, 0x931C232238140050, 0x55E5E50369860004, 0x71771395C22470D0, 0x3BE6B33D60BD7A78, 0xF46155ECEADFBA2D, 0xB4120CC4D6002200, 0x7BA585BBD17876F1, 0xBC6CB45A2DB5A600, 0x5E31AF411D2F5210, 0x52B9741295094A00, 0x7737816369C2E06E, 0x8F9C400103F08321, 0x7431A0008A704301, 0x8B82A0C01AEA0012, 0xC75982DF3C2C1D2, 0xE5AE01920F078582, 0xADDB860488103104, 0xA8B31F0A8B426BFA};
uint64_t bishopMN[64] = {0x3D40145521470103, 0x606D029090D0048, 0x28D01B0A0F240137, 0x5A07EA7CF43E9D4F, 0x4624042260BCCDF3, 0x2C60304602EEDFE, 0xA043EC039587147D, 0xE863220910051055, 0xF43CBC84500C4D02, 0x803E48010803A905, 0xBF32C1DE02510B20, 0x509B5820D4C485C2, 0x1FAFD41C20709799, 0x6D96C2080E1952A3, 0x547306C606304007, 0x2B6CB60B04063E86, 0xA1F1FC750FD00720, 0x652422D04508450B, 0x4E5814100BC31460, 0x3B27B8AF68E01031, 0x8C0BFE72836BEF99, 0x24719D233B0B73C3, 0x89FD8EC7541057F7, 0xE9EB05DE2C060E04, 0x82604587B8086818, 0x327B709A600A0E06, 0x69791C9646F632DF, 0xCAA10210E5F0803A, 0xA51846AE650F6F41, 0x53C4398F9EEF70F2, 0x294A508EE08062D, 0xC6EB02C4E1041F92, 0x9CB22020CFFD082E, 0x937D1C2084F2581A, 0xB44E4128145007C0, 0x5E384DB8E5A5A2, 0xD86D7DB9A8F6E8EB, 0x1C3A5BAB004E0097, 0x59838150323D701, 0x6F711AC903B6011E, 0xFEE91420E04074A1, 0x4D440B0818616651, 0xAEAB8EF2EFF9B3DC, 0x210F2E0972561333, 0xF8B57A9685A15280, 0x5C403410C4106B80, 0x5E065C8D020A8C01, 0x791C388601421206, 0xA043EC039587147D, 0x18C0A40744300FE4, 0x21E28AEDA8D00698, 0x22723A2E42021C25, 0x441A2151B20E0043, 0x5DC3E0B4694A0187, 0x34D1F09A27E0D2FE, 0x606D029090D0048, 0xE863220910051055, 0x2B6CB60B04063E86, 0x643054DB6C16180D, 0x791C388601421206, 0x69DFDD4D701E1601, 0x330C10C8F11B2200, 0xF43CBC84500C4D02, 0x3D40145521470103};

//Bitboards for each file, rank, and diagonal
uint64_t FILES[8] = {0x0101010101010101, 0x0202020202020202, 0x0404040404040404, 0x0808080808080808, 0x1010101010101010, 0x2020202020202020, 0x4040404040404040, 0x8080808080808080};
uint64_t RANKS[8] = {0xFF00000000000000, 0x00FF000000000000, 0x0000FF0000000000, 0x000000FF00000000, 0x00000000FF000000, 0x0000000000FF0000, 0x000000000000FF00, 0x00000000000000FF};
uint64_t DIAGONALS_NE[15] = {0x1, 0x102, 0x10204, 0x1020408, 0x102040810, 0x10204081020, 0x1020408102040, 0x102040810204080, 0x204081020408000, 0x408102040800000, 0x810204080000000, 0x1020408000000000, 0x2040800000000000, 0x4080000000000000, 0x8000000000000000};
uint64_t DIAGONALS_NW[15] = {0x80, 0x8040, 0x804020, 0x80402010, 0x8040201008, 0x804020100804, 0x80402010080402, 0x8040201008040201, 0x4020100804020100, 0x2010080402010000, 0x1008040201000000, 0x804020100000000, 0x402010000000000, 0x201000000000000, 0x100000000000000};

//Diagonal lookup
int diagLU_NE[64] = {0, 1, 2, 3, 4, 5, 6, 7, 1, 2, 3, 4, 5, 6, 7, 8, 2, 3, 4, 5, 6, 7, 8, 9, 3, 4, 5, 6, 7, 8, 9, 10, 4, 5, 6, 7, 8, 9, 10, 11, 5, 6, 7, 8, 9, 10, 11, 12, 6, 7, 8, 9, 10, 11, 12, 13, 7, 8, 9, 10, 11, 12, 13, 14};
int diagLU_NW[64] = {7, 6, 5, 4, 3, 2, 1, 0, 8, 7, 6, 5, 4, 3, 2, 1, 9, 8, 7, 6, 5, 4, 3, 2, 10, 9, 8, 7, 6, 5, 4, 3, 11, 10, 9, 8, 7, 6, 5, 4, 12, 11, 10, 9, 8, 7, 6, 5, 13, 12, 11, 10, 9, 8, 7, 6, 14, 13, 12, 11, 10, 9, 8, 7};

